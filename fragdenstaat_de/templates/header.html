{% load i18n %}
{% load static %}
{% load icons %}
{% load content_helper %}
{% load thumbnail %}

{% load cms_tags %}
{% load account_tags %}

{% if request.user.is_authenticated %}
  {% get_menu_items as menu_items %}
{% endif %}

<header id="header">
  <div class="container g-lg-0">
    <nav class="navbar navbar-fds bg-body">
      {% page_url "home" as home_url %}
      <a href="{{ home_url|default:'/' }}" class="navbar-brand navbar-brand-fds">
          {% render_svg "img/header_logo.svg" %}
        <span class="visually-hidden visually-hidden-focusable">{% block nav_brand_name %}{{ SITE_NAME }}{% endblock %}</span>
      </a>
      <div class="navbar-expand-md">
        <button class="navbar-toggler ms-auto position-relative z-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#menu" aria-controls="menu" aria-label="{% translate "Toggle navigation" %}">
          <span class="navbar-toggler-icon"></span>
          {% translate "Menu" %}
        </button>
        <div class="offcanvas offcanvas-start" tabindex="-1" id="menu" aria-labelledby="menu-label">
          <div class="offcanvas-header">
            {% render_svg "img/header_logo.svg" %}
            <h5 id="menu-label" class="visually-hidden">{% translate "Main Menu" %}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="{% translate "Close" %}"></button>
          </div>
          <div class="offcanvas-body d-flex flex-column">
            <ul class="navbar-nav navbar-nav-primary">
              <li class="nav-item">
                <a class="nav-link" href="{% url 'foirequest-list' %}">
                  {% blocktrans %}Requests{% endblocktrans %}
                </a>
              </li>

              {% page_url "blog" as blog_url %}
              <li class="nav-item">
                <a class="nav-link" href="{{ blog_url|default:'/blog/' }}">
                  {% blocktrans %}Investigations{% endblocktrans %}
                </a>
              </li>

              {% page_url "campaigns" as campaigns_url %}                
              <li class="nav-item">
                <a class="nav-link" href="{{ campaigns_url|default:'/kampagnen/' }}">
                  {% blocktrans %}Campaigns{% endblocktrans %}
                </a>
              </li>
            </ul>
            <ul class="navbar-nav navbar-nav-secondary me-auto">
              {% page_url "about" as about_url %}                
              <li class="nav-item">
                <a class="nav-link" href="{{ about_url|default:"/ueber-uns/" }}">{% translate "About us" %}</a>
              </li>
              {% page_url "newsletter" as newsletter_url %}                
              <li class="nav-item">
                <a class="nav-link" href="{{ newsletter_url }}">{% translate "Newsletter" %}</a>
              </li>
              {# Show either donate or signin as last item #}
              {% if request.user.is_authenticated %}
                <li class="nav-item logged-in">
                  <a class="nav-link fw-bold text-danger" href="{{ donate_url|default:'/spenden/' }}?pk_campaign=site-header&pk_keyword={{ request.path | urlencode }}">
                    <i class="fa fa-heart" aria-hidden="true"></i>
                    {% blocktrans %}Donate{% endblocktrans %}
                  </a>
                </li>
              {% else %}
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'account-login' %}?next={{ request.path|urlencode }}">
                    <i class="fa fa-sign-in" aria-hidden="true"></i>
                    {% blocktrans %}Sign in{% endblocktrans %}
                  </a>
                </li>
              {% endif %}
            </ul>
            <div class="d-md-none">
              <hr/>
              <form action="{% url 'foirequest-list' %}" method="get">
                <p>{% blocktrans %}Search requests, authorities, investigations etc.{% endblocktrans %}</p>
                <div class="input-group">
                  <input type="text" name="q" class="form-control">
                  <button type="submit" class="btn btn-outline-primary">
                    {% translate "Search" %}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <ul class="navbar-nav ms-auto d-flex flex-row">
        <li class="nav-item d-none {% if request.user.is_authenticated %}d-sm-block{% else %}d-md-block{% endif %}">
          <button class="nav-link fw-bold me-2" data-bs-toggle="modal" data-bs-target="#search-modal">
            <i class="fa fa-search" aria-hidden="true"></i>
            <span class="d-none d-lg-inline-block">{% blocktrans %}Search{% endblocktrans %}</span>
          </a>
        </li>
        <li class="nav-item {% if request.user.is_authenticated %}d-md-none{% endif %}">
          <a class="nav-link fw-bold text-danger" href="{{ donate_url|default:'/spenden/' }}?pk_campaign=site-header&pk_keyword={{ request.path | urlencode }}">
            <i class="fa fa-heart" aria-hidden="true"></i>
            <span class="{% if request.user.is_authenticated %}d-none{% endif %}">{% blocktrans %}Donate{% endblocktrans %}</span>
          </a>
        </li>
        {% block nav_account_login %}
          {% if request.user.is_authenticated %}
            <li class="nav-item ms-lg-2 align-self-center">
              <button class="btn py-0 pe-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#user-menu" aria-controls="user-menu" aria-label="{% translate "Toggle navigation" %}">
                {% if request.user.profile_photo %}
                  <img width="32" height="32" src="{% thumbnail request.user.profile_photo 64x64 %}" alt="{{ request.user.get_full_name }}" class="img-fluid rounded-circle">
                {% else %}
                  <i class="fa fa-user" aria-hidden="true"></i>
                  <span class="text-truncate text-uppercase">{{ request.user.first_name.0 }} {{ request.user.last_name.0 }}</span>
                {% endif %}
              </button>      
            </li>
          {% endif %}
        {% endblock %}
      </ul>
      {% if request.user.is_authenticated %}
        <div class="offcanvas offcanvas-end" tabindex="-1" id="user-menu" aria-labelledby="user-menu-label">
          <div class="offcanvas-header text-bg-callout">
            <h5 id="user-menu-label" class="visually-hidden">{% translate "Account Menu" %}</h5>
            {% if request.user.profile_photo %}
              <img width="32" height="32" src="{% thumbnail request.user.profile_photo 64x64 %}" alt="{{ request.user.get_full_name }}" class="img-fluid rounded-circle">
            {% endif %}
            <div class="flex-column">
              <span class="d-block text-truncate">{{ request.user.get_full_name }}</span>
              <small class="d-block text-truncate">{{ request.user.email }}</small>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="{% translate "Close" %}"></button>
          </div>
          <div class="offcanvas-body">
            <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
              {% for menu_item in menu_items.before_request %}
                <li class="nav-item">
                  <a class="nav-link" href="{{ menu_item.url }}">
                    {{ menu_item.label }}
                  </a>
                </li>
              {% endfor %}
              {% for menu_item in menu_items.before_settings %}
                <li class="nav-item">
                  <a class="nav-link" href="{{ menu_item.url }}">
                    {{ menu_item.label }}
                  </a>
                </li>
              {% endfor %}
              {% for menu_item in menu_items.after_settings %}
                <li class="nav-item">
                  <a class="nav-link" href="{{ menu_item.url }}">
                    {{ menu_item.label }}
                  </a>
                </li>
              {% endfor %}
              <li class="nav-item">
                <hr/>
                <form action="{% url 'account-logout' %}" method="post">
                  {% csrf_token %}
                  <button type="submit" class="nav-link">
                    {% blocktrans %}Log out{% endblocktrans %}
                  </button>
                </form>
              </li>
            </ul>
          </div>
        {% endif %}
      </div>
    </nav>
  </div>
  <div class="modal" tabindex="-1" id="search-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-body">
          <form action="{% url 'foirequest-list' %}" method="get">
            <button type="button" class="btn-close float-end" data-bs-dismiss="modal" aria-label="{% translate "Close" %}"></button>
            <p>{% blocktrans %}Search requests, authorities, investigations etc.{% endblocktrans %}</p>
            <div class="input-group">
              <input type="text" name="q" class="form-control" data-focus="true">
              <button type="submit" class="btn btn-outline-primary">
                {% translate "Search" %}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
</header>

{% comment %}
<header id="header" class="header container d-flex justify-content-between align-items-center pt-4 pt-md-5 pb-2">

  {% block nav_brand %}
  <div class="header__branding">
    {% page_url "home" as home_url %}
    <a href="{{ home_url|default:'/' }}" class="text-body-emphasis">
      {% block nav_brand_image %}{% render_svg "img/header_logo.svg" %}{% endblock %}
      <span class="visually-hidden visually-hidden-focusable">{% block nav_brand_name %}{{ SITE_NAME }}{% endblock %}</span>
    </a>
  </div>
  {% endblock %}

  {# Mobile menu #}
  <div class="drawer-menu d-flex d-md-none">

    {# Spenden button #}
    <a title="{% blocktrans %}Donate{% endblocktrans %}" class="d-flex d-md-none align-items-center text-danger text-decoration-none me-1" href="/spenden/?pk_campaign=site-header&pk_keyword={{ request.path | urlencode }}">
      <i class="fa fa-heart d-md-none d-lg-inline-block me-1" aria-hidden="true"></i>
    </a>

    {# Toggle button #}
    <button type="button" class="drawer-menu__toggle" aria-label="{% translate 'Menu' %}">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </button>

    {# Menu wrapper #}
    <nav class="drawer-menu__wrapper drawer-menu__wrapper--inital">

      {# User menu #}
      {% if request.user.is_authenticated %}
      <ul class="list-unstyled mb-0">
        <li class="py-3 px-3 bg-blue-800 text-white">
          <span class="d-block text-truncate">{{request.user.get_full_name}}</span>
          <small class="d-block text-truncate">{{request.user.email}}</small>
        </li>
        {% for menu_item in menu_items.before_request %}
          <li>
            <a class="drawer-menu__link drawer-menu__link--blue" href="{{ menu_item.url }}">
              {{ menu_item.label }}
            </a>
          </li>
        {% endfor %}

        {% for menu_item in menu_items.before_settings %}
          <li>
            <a class="drawer-menu__link drawer-menu__link--blue" href="{{ menu_item.url }}">
              {{ menu_item.label }}
            </a>
          </li>
        {% endfor %}

        {% for menu_item in menu_items.after_settings %}
          <li>
            <a class="drawer-menu__link drawer-menu__link--blue" href="{{ menu_item.url }}">
              {{ menu_item.label }}
            </a>
          </li>
        {% endfor %}
        <li>
          <form action="{% url 'account-logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="drawer-menu__link drawer-menu__link--blue border-0">
              <i class="fa fa-sign-out" aria-hidden="true"></i>
              <span>{% blocktrans %}Log out{% endblocktrans %}</span>
            </button>
          </form>
        </li>
      </ul>
      {% endif %}

      {# Page Menu #}
      <ul class="list-unstyled mb-0 {% if not request.user.is_authenticated %}mt-3{% endif %}">
        {# Anfragen drawer-menu__dropdown #}
        <li>
          <a class="drawer-menu__link drawer-menu__link--white drawer-menu__dropdown-trigger" href="{% url 'foirequest-list' %}">
            <span>{% blocktrans %}Requests{% endblocktrans %}</span>
            <i class="fa fa-caret-down" aria-hidden="true"></i>
          </a>

          <ul class="list-unstyled mb-0 drawer-menu__dropdown-content">
            <li>
              <a class="drawer-menu__link drawer-menu__link--white" href="{% url 'foirequest-list' %}">
                {% blocktrans %}See requests{% endblocktrans %}
              </a>
            </li>
            <li>
              <a class="drawer-menu__link drawer-menu__link--white" href="{% url 'foirequest-make_request' %}">
                {% blocktrans %}Make request{% endblocktrans %}
              </a>
            </li>
            {% page_url "beginnersguide" as beginners_url %}
            {% if beginners_url %}
              <li>
                <a class="drawer-menu__link drawer-menu__link--white" href="{{ beginners_url }}">
                  {% blocktrans %}Beginner's guide{% endblocktrans %}
                </a>
              </li>
            {% endif %}
          </ul>
        </li>
        <li>
          {% page_url "campaigns" as campaigns_url %}
          <a class="drawer-menu__link drawer-menu__link--white" href="{{ campaigns_url|default:'/kampagnen/' }}">
            {% blocktrans %}Campaigns{% endblocktrans %}
          </a>
        </li>
        <li>
          {% page_url "blog" as blog_url %}
          <a class="drawer-menu__link drawer-menu__link--white" href="{{ blog_url|default:'/blog/' }}">
            {% blocktrans %}Investigations{% endblocktrans %}
          </a>
        </li>
        {% if not request.user.is_authenticated %}
        <li>
          <a class="drawer-menu__link drawer-menu__link--white" href="{% url 'account-login' %}?next={{ request.path|urlencode }}">
            <i class="fa fa-sign-in" aria-hidden="true"></i>
            <span>{% blocktrans %}Sign in{% endblocktrans %}</span>
          </a>
        </li>
        {% endif %}
      </ul>

      {# Spenden CTA #}
      <p class="py-3 px-3">
        {% trans "You like our work? Support us with a donation!" %}<br>
        {% page_url "donate" as donate_url %}
        <a class="btn btn-outline-primary mt-2" href="{{ donate_url|default:'/spenden/' }}?pk_campaign=site-header&pk_keyword={{ request.path | urlencode }}">
          {% blocktrans %}Donate now{% endblocktrans %}
        </a>
      </p>
    </nav>
    <div class="drawer-menu__backdrop"></div>
  </div>
  {# Mobile menu END #}

  {# Desktop/Tablet top-menu #}
  <nav class="top-menu navbar d-none d-sm-none d-md-flex justify-content-between flex-lg-fill ms-md-4 ms-lg-6">
    {# left top-menu #}

    {% block nav %}
    <ul class="top-menu__list">
      <li class="top-menu__listitem dropdown me-md-3 me-lg-4">
        {# Anfragen top-menu__dropdown #}
        <button type="button" class="top-menu__link dropdown-toggle" id="anfragenDropdownMenu" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          {% blocktrans %}Requests{% endblocktrans %}
        </button>
        <div class="dropdown-menu top-menu--drop-left" aria-labelledby="anfragenDropdownMenu">
          <a class="dropdown-item top-menu__link" href="{% url 'foirequest-list' %}">
            {% blocktrans %}See requests{% endblocktrans %}
          </a>
          <a class="dropdown-item top-menu__link" href="{% url 'foirequest-make_request' %}">
            {% blocktrans %}Make requests{% endblocktrans %}
          </a>
          {% if beginners_url %}
            <a class="dropdown-item top-menu__link" href="{{ beginners_url }}">
              {% blocktrans %}Beginner's guide{% endblocktrans %}
            </a>
          {% endif %}
        </div>
      </li>
      <li class="top-menu__listitem me-md-3 me-lg-4">
        <a class="top-menu__link" href="{{ campaigns_url|default:'/kampagnen/' }}">
          {% blocktrans %}Campaigns{% endblocktrans %}
        </a>
      </li>
      <li class="top-menu__listitem me-md-3 me-lg-0">
        <a class="top-menu__link" href="{{ blog_url|default:'/blog/' }}">
          {% blocktrans %}Investigations{% endblocktrans %}
        </a>
      </li>
    </ul>
    {% endblock %}

    {# right top-menu #}
    <ul class="top-menu__list ms-auto">
      {% block nav_donate %}
      <li class="top-menu__listitem">
        <a class="top-menu__link text-danger" href="{{ donate_url|default:'/spenden/' }}?pk_campaign=site-header&pk_keyword={{ request.path | urlencode }}">
          <i class="fa fa-heart d-md-none d-lg-inline-block" aria-hidden="true"></i>
          <span>{% blocktrans %}Donate{% endblocktrans %}</span>
        </a>
      </li>
      {% endblock %}
      {% block nav_account_login %}
      <li class="top-menu__listitem dropdown ms-md-3 ms-lg-4">
        {% if request.user.is_authenticated %}
          <button type="button" class="top-menu__link dropdown-toggle" id="userDropdownMenu" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fa fa-user" aria-hidden="true"></i>
            <span>{{ request.user.first_name }}</span>
          </button>
          <div class="dropdown-menu top-menu--drop-right pt-0" aria-labelledby="userDropdownMenu">
            <div class="top-menu__usermenu py-3 px-3 mb-1">
              <span class="d-block text-truncate">{{ request.user.get_full_name }}</span>
              <small class="d-block text-truncate">{{ request.user.email }}</small>
            </div>

            {% include "account/menu.html" with menu_items=menu_items %}

            <div class="dropdown-divider my-1"></div>
            <div class="dropdown-item top-menu__link">
              <form action="{% url 'account-logout' %}" method="post">
                {% csrf_token %}
                <button type="submit" class="top-menu__link w-100">
                  {% blocktrans %}Log out{% endblocktrans %}
                </button>
              </form>
            </div>
          </div>
        {% else %}
          <a class="top-menu__link" href="{% url 'account-login' %}?next={{ request.path|urlencode }}">
            <i class="fa fa-user" aria-hidden="true"></i>
            <span>{% blocktrans %}Sign in{% endblocktrans %}</span>
          </a>
        {% endif %}
      </li>
      {% endblock %}
    </ul>
  </nav>
  {# Desktop/Tablet top-menu END #}

</header>
{% endcomment %}
